<html lang="en">
<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>更多数据</title>
    <link href="favicon.ico" rel="icon">
    <link href="css/vendor/bootstrap.min.css" rel="stylesheet">
    <link href="css/flat-ui.css" rel="stylesheet">
    <style>
        body {
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #F8F8F8;
            opacity: 0;
            transition: opacity 0.2s
        }

        body.bactive {
            opacity: 1
        }

        .head {
            padding: 0 32px;
            border-radius: 0;
            margin-bottom: 0;
        }

        .flex {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        h6 {
            margin: auto 32px auto 0;
        }

        .sub-head {
            width: 100%;
            background-color: rgba(52, 73, 94, 0.95);
            padding-bottom: 36px;
        }

        .description {
            color: whitesmoke;
            font-size: 16px;
            padding: 24px 36px;
            line-height: 28px;
        }

        .float-bar {
            z-index: 1000;
            height: 72px;
            width: calc(100% - 72px);
            margin: -36px 36px 16px 36px;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
            padding: 0 36px;
        }

        .quicktask {
            margin: auto 16px auto 0;
            border: 1px solid rgba(0, 0, 0, 0.3);
            padding: 4px 12px;
            font-size: 14px;
            color: #333333;
            min-width: 72px;
            text-align: center;
        }

        .card {
            width: calc(100% - 72px);
            margin: 0 36px 16px 36px;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
            border: none;
            background-color: white;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.12);
            padding: 0 36px;
        }

        .duration {
            margin-right: 32px;
            font-weight: bold;
            color: #1b1e21;
        }

        .bottom-line {
            background: #00c6ff; /* fallback for old browsers */
            background: -webkit-linear-gradient(to right, #0072ff, #00c6ff); /* Chrome 10-25, Safari 5.1-6 */
            background: linear-gradient(to right, #0072ff, #00c6ff); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
            height: 6px;
            border-radius: 2px;
            margin-top: -4px;
        }

        .transparent {
            background: transparent;
        }

        .hr {
            width: 100%;
            height: 1px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .segment, .dimension {
            margin-top: 12px;
            margin-bottom: 12px;
            min-width: 100px;
            text-align: center;
            color: #1b1e21;
            background-color: #EEEEEE;
        }

        .active {
            color: white;
            background-color: rgba(52, 73, 94, 0.95);
        }

        tr {
            height: 48px;
        }

        tr th:first-child, tr td:nth-child(1) {
            width: 8%;
            padding: 0 48px 0 24px;
            text-align: right;
        }

        tr th:nth-child(n+2):nth-child(-n+4), tr td:nth-child(n+2):nth-child(-n+4) {
            width: 16%;
            padding: 0 48px 0 24px;
            text-align: left;
        }

        tr th:nth-child(n+5), tr td:nth-child(n+5) {
            width: 15%;
            padding: 0 48px 0 24px;
            text-align: right;
        }

        /*设置奇数行颜色*/
        table tr:nth-child(odd) {
            background: #EEEEEE;
        }

        /*设置偶数行颜色*/
        table tr:nth-child(even) {
            background: #F8F8F8;
        }

        .footer {
            margin-right: 24px;
            font-size: 16px;
        }

        a.duration, a.duration:hover, a.duration:active, a.duration:visited, a.duration:link, a.duration:focus {
            color: #1b1e21;
        }

        table {
            margin-top: 0;
            width: 100%;
        }

        tr {
            width: 100%;
        }

        #area-table > table > tbody > tr > td {
            width: 0;
            margin: 0 16px;
            text-align: right;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.6);
        }

        .bdSug_wpr {
            position: absolute;
            z-index: 99999;
            top: 48px;
            right: 48px;
            background-color: rgba(52, 73, 94, 0.95);
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
        }

        ul {
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            padding: 0;
        }

        ul li {
            list-style: none;
            padding: 0 24px;
            height: 48px;
            line-height: 48px;
            background-color: transparent;
            color: whitesmoke;
        }

        ul li.active {
            background-color: #F8F8F8;
            color: #1b1e21;
        }

        iframe {
            border: none;
            margin: 0;
        }

    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/echarts/4.2.1/echarts.js"></script>
    <script type="text/javascript" src="china.js"></script>
    <script type="text/javascript" src="macarons.js"></script>
    <script type="text/javascript" src="walden.js"></script>
    <script>
        let chartsArr = [];
        let type = 1;
        let page = 1;
        let level = 1;
        let maxPage = 1;
        let totalCount = 0;
        let rankType = 'followers';
        let accountRankDataArr = [];
        let rankPage = 1;
        let rankMaxPage = 1;
        let searchReq;

        let headKeys = [[],
            ['序号', '名称', '代码', '所属板块', '持有组合数', '比重/%', '满仓比重/%'],
            ['序号', '名称', '比重/%', '满仓比重/%'],
            ['序号', '名称', '代码', '调仓比重/%'],
            ['序号', '名称', '代码', '主理人', '净值', '在榜天数'],
            ['序号', '昵称', '省份', '简介', '发言数', '关注人数', '关注人数(不含匿名用户)']];
        let paramKeys = [[],
            ['rank', 'stockName', 'stockSymbol', 'segmentName', 'count', 'percentWithCash', 'percent'],
            ['rank', 'segmentName', 'percentWithCash', 'percent'],
            ['rank', 'stockName', 'stockSymbol', 'percent'],
            ['rank', 'name', 'symbol', 'screenName', 'netValue', 'showDaysCount'],
            ['rank', 'screenName', 'province', 'description', 'statusCount', 'followersCount', 'realFans']];
        let selectors = ['a.segment', 'a.dimension'];
        let chartMode = !1;
        let typeNameArr = ['', 'stock', 'segment', 'rebalancing', 'cube'];

        function setIframeHeight(iframe) {
            if (iframe) {
                var iframeWin = iframe.contentWindow || iframe.contentDocument.parentWindow;
                console.log('height=' + iframe.height);
                if (iframeWin.document.body) {
                    console.log('height=' + iframe.height);
                    iframe.height = iframeWin.document.documentElement.scrollHeight || iframeWin.document.body.scrollHeight;
                }
                console.log('height=' + iframe.height);
            }
        };

        $(function () {
            $('body').addClass('bactive');

            let iframe = document.getElementById('iframe');
            iframe.onload = function () {
                this.style.visibility = 'hidden';
                this.setAttribute('height', 'auto');
                setTimeout(function () {
                    iframe.setAttribute('height', iframe.contentWindow.document.body.scrollHeight);
                    iframe.style.visibility = 'visible';
                }, 0);
            };

            // let top = $('nav')[0].height;
            // let width = $('.navbar-form').width();
            // let left = $('.navbar-form').offset().left;
            // console.log(top + '--' + width + '--' + left);
            // $("#autoSearch").css('top', top);
            // $("#autoSearch").css('width', width);
            // $("#autoSearch").css('left', left);
            // $('#navbarInput-01').on('keyup', function () {
            //     let key = $('#navbarInput-01').val();
            //     console.log(key);
            //     if(searchReq!=null){
            //         searchReq.abort();
            //     }
            //     if (key === "") {    　　　　　　　　  //无输入
            //         $("#autoSearch").css('display', 'none');    //隐藏列表框
            //         return;
            //     }
            //
            //     searchReq = $.ajax({
            //         url: "http://localhost:8080/cube/search?key=" + key,
            //         success: function (data) {
            //             console.log(data);
            //             $("#showResult").empty();
            //             let cubeList = data.data.list;
            //             cubeList.forEach(function (item) {
            //                 //生成列表元素,并添加鼠标悬浮事件(高亮):hover
            //                 //TODO 样式真尼玛难调
            //                 var $li = $("<li onclick='getChoose(this)' style='width: " + width + "px;'>" + item.name + "</li>").hover(function () {
            //                     $("li").removeClass("active");　　　　　//bootstrap　　　
            //                     $(this).addClass("active");
            //                 });
            //
            //                 $("#showResult").append($li);   　//添加列表
            //                 $("#autoSearch").show();　　　　　 //显示列表框
            //                 $("#autoSearch").css('display', 'block');
            //
            //             });
            //         }
            //     });
            //
            // });


            $('#track-cube').on('click', function () {
                fetchTrackCube(level);
            });
            $('#download').on('click', function () {
                console.log(type);
                console.log(level);
                $('#download').attr('href', 'http://118.25.182.189/moredata/download/' + typeNameArr[type] +
                    '?level=' + level);
                // $('#download').attr('href', 'http://localhost:8080/download/' + typeNameArr[type] +
                //     '?level=' + level);
            });

            $('#myModal').on('shown.bs.modal', function (event) {
                console.log(event);
                let modal = $(this);
                let data = trackCubeArr[level].data;
                let list = data.list;
                let html = '';
                list.forEach(function (item) {
                    html += item['stock_name'] + '---' + item['weight'] + '<br/>';
                });

                modal.find('#myModalLabel').text('风云榜跟踪组合--' + data['updatedAt']);
                modal.find('#track-cube-content')[0].innerHTML = html;
            });

            $('#data-container').show();
            $('#chart-container').hide();
            $('#rank-table-container').hide();

            //监听数据/图表展示方式的切换
            $('#chart-way').on("click", function () {
                $('#data-container').hide();
                $('#chart-container').show();
                accountPathArr.forEach(function (value, index, array) {
                    fetchAccountData(value, index);
                });
            });
            $('#data-way').on("click", function () {
                $('#data-container').show();
                $('#chart-container').hide();
            });

            $('#switch-mode').on("click", function () {
                console.log(chartMode);
                if (chartMode) {
                    $('#data-container').show();
                    $('#chart-container').hide();
                    $('#rank-table-container').hide();
                } else {
                    $('#data-container').hide();
                    $('#chart-container').show();
                    $('#rank-table-container').hide();
                    accountPathArr.forEach(function (value, index, array) {
                        fetchAccountData(value, index);
                    });
                }
                chartMode = !chartMode;
            });


            selectors.forEach(function (value) {
                $(value).mouseenter(function () {
                    if ($(this).hasClass('active')) {
                        $(this).css('color', 'white');
                    } else {
                        $(this).css('color', '#1b1e21');
                    }
                }).mouseleave(function () {
                    if ($(this).hasClass('active')) {
                        $(this).css('color', 'white');
                    } else {
                        $(this).css('color', '#1b1e21');
                    }
                }).click(function () {
                    $(value).css('color', '#1b1e21');
                    $(this).css('color', 'white');
                }).focusout(function () {
                    if ($(this).hasClass('active')) {
                        $(this).css('color', 'white');
                    } else {
                        $(this).css('color', '#1b1e21');
                    }
                });
            });


            let catIds = ['#stock', '#segment', '#rebalancing', '#showDays'];
            catIds.forEach(function (value) {
                $(value).on('click', function () {
                    switch (value) {
                        case '#stock':
                            type = 1;
                            break;
                        case '#segment':
                            type = 2;
                            break;
                        case '#rebalancing':
                            type = 3;
                            break;
                        case '#showDays':
                            type = 4;
                            break;
                    }
                    page = 1;
                    fillChartData(type, level, page);
                });
            });

            let rankCatIds = ['#rank-fans', '#rank-real-fans', '#rank-status'];
            rankCatIds.forEach(function (value) {
                $(value).on('click', function () {
                    switch (value) {
                        case '#rank-fans':
                            rankType = 'followers';
                            break;
                        case '#rank-real-fans':
                            rankType = 'realFans';
                            break;
                        case '#rank-status':
                            rankType = 'status';
                            break;
                    }
                    rankPage = 1;
                    fillRankTableData(rankType, rankPage);
                });
            });

            $('#account-overview').on('click', function () {
                console.log(chartMode);
                $("a#account-overview>.bottom-line").removeClass("transparent");
                $("a#account-rank>.bottom-line").addClass("transparent");
                $('#switch-mode').show();
                if (!chartMode) {
                    $('#data-container').show();
                    $('#chart-container').hide();
                    $('#rank-table-container').hide();
                } else {
                    $('#data-container').hide();
                    $('#chart-container').show();
                    $('#rank-table-container').hide();
                    accountPathArr.forEach(function (value, index, array) {
                        fetchAccountData(value, index);
                    });
                }
            });
            $('#account-rank').on('click', function () {
                $("a#account-overview>.bottom-line").addClass("transparent");
                $("a#account-rank>.bottom-line").removeClass("transparent");
                $('#switch-mode').hide();
                $('#rank-table-container').show();
                $('#data-container').hide();
                $('#chart-container').hide();
                rankPage = 1;
                fillRankTableData(rankType, rankPage);
            });

            let durationIds = ['#quarter', '#half-year', '#year'];
            durationIds.forEach(function (value) {
                $(value).on('click', function () {
                    switch (value) {
                        case '#quarter':
                            level = 1;
                            break;
                        case '#half-year':
                            level = 2;
                            break;
                        case '#year':
                            level = 3;
                            break;
                    }
                    $("#level-duration>a>.bottom-line").addClass("transparent");
                    $("#level-duration>a>.bottom-line:eq(" + (level - 1) + ")").removeClass("transparent");
                    page = 1;
                    fillChartData(type, level, page);
                });
            });
            $('#last-page').on('click', function () {
                if (page === 1) {
                    alert("已是第一页");
                    return;
                }
                page--;
                fillChartData(type, level, page);
            });
            $('#next-page').on('click', function () {
                if (page === maxPage) {
                    alert("已是最后一页");
                    return;
                }
                page++;
                fillChartData(type, level, page);
            });
            $('#account-last-page').on('click', function () {
                if (rankPage === 1) {
                    alert("已是第一页");
                    return;
                }
                rankPage--;
                fillRankTableData(rankType, rankPage);
            });
            $('#account-next-page').on('click', function () {
                if (rankPage === rankMaxPage) {
                    alert("已是最后一页");
                    return;
                }
                rankPage++;
                fillRankTableData(rankType, rankPage);
            });

            fillChartData(type, level, page);
        });

        function getChoose(data) {
            console.log('index.html--getChoose');
            $('iframe').contents().find("#navbarInput-01").val($(data).text());
            $("#autoSearch").hide();
        }

        /**
         * 填充表格数据
         * @param type
         * @param level
         * @param page
         */
        function fillChartData(type, level, page) {
            if (chartsArr[type] == null) {
                chartsArr[type] = [];
                fetchChartData(type, level);
                return;
            }
            if (chartsArr[type][level] == null) {
                fetchChartData(type, level);
                return;
            }
            this.type = type;
            this.level = level;
            this.page = page;

            let list = chartsArr[type][level].data.list;
            let html = "<table><tr>";

            headKeys[type].forEach(function (value) {
                html += '<th>' + value + '</th>';
            });
            html += '</tr>';

            for (let i = 15 * (page - 1), count = 0; count < 15; i++, count++) {
                html += '<tr>';
                let item = list[i];
                if (item == null) {
                    headKeys[type].forEach(function () {
                        html += "<td></td>";
                    });
                    html += '</tr>';
                    continue;
                }


                paramKeys[type].forEach(function (value) {
                    if (type === 4 && value === 'symbol') {
                        html += '<td><a target="_blank" href="https://xueqiu.com/P/' + item[value] + '">' + item[value] + '</a></td>';
                        return;
                    }

                    if (type === 4 && value === 'screenName') {
                        html += '<td><a target="_blank" href="https://xueqiu.com/u/' + item['ownerId'] + '">' + item[value] + '</a></td>';
                        return;
                    }

                    if (value === 'percent'
                        || value === 'percentWithCash'
                        || value === 'netValue') {
                        html += '<td>' + item[value].toFixed(type === 3 ? 6 : 4) + '</td>';
                    } else {
                        html += '<td>' + item[value] + '</td>';
                    }
                });
                html += '</tr>';
            }
            html += "</table>";
            document.getElementById('chart').innerHTML = html;
            totalCount = chartsArr[type][level].data['count'];
            maxPage = totalCount % 15 === 0 ? totalCount / 15 : Math.ceil(totalCount / 15);
            document.getElementById('page').innerHTML = page + "/" + maxPage;
            document.getElementById('size').innerHTML = "共" + totalCount + "条数据";
            let cash = chartsArr[type][level].data['cash'];
            document.getElementById('cash').innerHTML = cash == null ? '' : ("现金仓位:" + cash + "%");
            let updatedAt = chartsArr[type][level].data['updatedAt'];
            document.getElementById('update-time').innerHTML = "更新于" + updatedAt;
        }

        /**
         * 请求接口数据
         * @param type
         * @param level
         */
        function fetchChartData(type, level) {
            let ajax = new XMLHttpRequest();
            ajax.open('get', 'http://118.25.182.189/moredata/analysis?type=' + type + '&level=' + level);
            ajax.send();
            ajax.onreadystatechange = function () {
                if (ajax.readyState === 4 && ajax.status === 200) {
                    let chart = ajax.responseText;
                    chart = JSON.parse(chart);
                    chartsArr[type][level] = chart;
                    fillChartData(type, level, 1);
                }
            }
        }

        /**
         * 填充表格数据
         * @param rankType
         * @param rankPage
         */
        function fillRankTableData(rankType, rankPage) {
            let rankTypeIndex = rankType === 'followers' ? 0 : 1;
            if (accountRankDataArr[rankTypeIndex] == null) {
                fetchAccountRank(rankType);
                return;
            }
            this.rankType = rankType;
            this.rankPage = rankPage;

            let list = accountRankDataArr[rankTypeIndex].data.list;
            let html = "<table><tr>";

            headKeys[5].forEach(function (value, index, array) {
                if (index === 2) {
                    html += '<th style="width: 10%;">' + value + '</th>';
                } else if (index === 3) {
                    html += '<th style="width: 20%;">' + value + '</th>';
                } else {
                    html += '<th>' + value + '</th>';
                }
            });
            html += '</tr>';

            for (let i = 15 * (rankPage - 1), count = 0; count < 15; i++, count++) {
                html += '<tr>';
                let item = list[i];
                if (item == null) {
                    headKeys[5].forEach(function (value, index, array) {
                        if (index === 2) {
                            html += '<td style="width: 10%;"></td>';
                        } else if (index === 3) {
                            html += '<td style="width: 20%;"></td>';
                        } else {
                            html += '<td></td>';
                        }
                    });
                    html += '</tr>';
                    continue;
                }


                paramKeys[5].forEach(function (value, index, array) {
                    if (index === 1) {
                        html += '<td><a target="_blank" href="https://xueqiu.com/u/' + item['id'] + '">' + item[value]
                            + '</a></td>';
                    } else if (index === 2) {
                        html += '<td style="width: 10%;">' + item[value] + '</td>';
                    } else if (index === 3) {
                        html += '<td style="width: 20%;">' + item[value] + '</td>';
                    } else {
                        html += '<td>' + item[value] + '</td>';
                    }
                });
                html += '</tr>';
            }
            html += "</table>";
            document.getElementById('rank-table').innerHTML = html;
            rankMaxPage = 34;
            document.getElementById('account-page').innerHTML = rankPage + "/" + rankMaxPage;
            document.getElementById('account-size').innerHTML = "共500条数据";
        }

        /**
         * 请求接口数据
         * @param rankType
         */
        function fetchAccountRank(rankType) {
            let ajax = new XMLHttpRequest();
            ajax.open('get', 'http://118.25.182.189/moredata/account/rank/' + rankType);
            ajax.send();
            ajax.onreadystatechange = function () {
                if (ajax.readyState === 4 && ajax.status === 200) {
                    let chart = ajax.responseText;
                    accountRankDataArr[rankType === 'followers' ? 0 : 1] = JSON.parse(chart);
                    fillRankTableData(rankType, 1);
                }
            }
        }


        let trackCubeArr = [];

        /**
         * 请求接口数据
         * @param type
         * @param level
         */
        function fetchTrackCube(level) {
            let ajax = new XMLHttpRequest();
            ajax.open('get', 'http://118.25.182.189/moredata/cube/track?level=' + level);
            ajax.send();
            ajax.onreadystatechange = function () {
                if (ajax.readyState === 4 && ajax.status === 200) {
                    let responseText = ajax.responseText;
                    trackCubeArr[level] = JSON.parse(responseText);
                }
            }
        }

    </script>
</head>
<body style="position:relative;z-index:10;">
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">
                    风云榜跟踪组合
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>

            </div>
            <div class="modal-body" id="track-cube-content">
                在这里添加一些文本
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary">
                    提交更改
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<div id='autoSearch' class="bdSug_wpr" style="height:auto;display: none;position:absolute;z-index:110;">
    <ul id='showResult' style="background: rgba(52, 73, 94, 0.95);"></ul>
</div>

<iframe scrolling="no" src="common/head.html" width="100%" id="iframe" style="position:relative;z-index:100;">
</iframe>

<div class="float-bar flex" style="position:relative;z-index:100;">
    <h6 style="margin-right: 24px;">快速通道</h6>
    <div class="quicktask">个股</div>
    <div class="quicktask">板块</div>
    <div class="quicktask">调仓</div>
    <div class="quicktask" style="border: none;">添加</div>
</div>
<div class="card">
    <div class="flex" style="height: 48px;" id="level-duration">
        <a id="quarter" class="duration" href="javascript:void(0);">近三个月
            <div class="bottom-line"></div>
        </a>
        <a id="half-year" class="duration" href="javascript:void(0);">近六个月
            <div class="bottom-line transparent"></div>
        </a>
        <a id="year" class="duration" href="javascript:void(0);">近一年
            <div class="bottom-line transparent"></div>
        </a>
        <div style="flex: 1;"></div>
        <a id="download" target="_blank" href="#" style="margin: 0 36px;">
            <b>Excel导出</b>
        </a>
        <a id="track-cube" href="javascript:void(0);" data-toggle="modal" data-target="#myModal">
            <b>查看跟踪组合</b>
        </a>
    </div>
    <div class="hr"></div>
    <!--<div class="btn-toolbar">-->
    <div class="flex">
        <div class="btn-group">
            <a id="stock" class="segment btn  active" href="#fakelink">个股</span></a>
            <a id="segment" class="segment btn " href="#fakelink">板块</a>
            <a id="rebalancing" class="segment btn" href="#fakelink">调仓</a>
            <a id="showDays" class="segment btn" href="#fakelink">在榜天数</a>
        </div>
        <b id="cash" style="margin-left: 24px;"></b>
        <div id="update-time" style="flex: 1;text-align: right;"></div>

    </div>

    <!--</div> &lt;!&ndash; /toolbar &ndash;&gt;-->
    <div id="chart" style="width: 100%;"></div>
    <!--<div class="hr"></div>-->
    <div class="flex" style="flex-direction:row-reverse;margin: 12px 0;">
        <div class="footer" id="size">共0条数据</div>
        <a id="next-page" class="footer" href="javascript:void(0);">下一页</a>
        <div class="footer" id="page">1/1</div>
        <a id='last-page' class="footer" href="javascript:void(0);">上一页</a>

    </div>

</div>

<div class="card" id="account-data-card">
    <div class="flex" style="height: 48px;">
        <a class="duration" href="javascript:void(0);" id="account-overview">用户数据一览
            <div class="bottom-line"></div>
        </a>
        <a class="duration" href="javascript:void(0);" id="account-rank">用户排行TOP500
            <div class="bottom-line transparent"></div>
        </a>
        <a id="switch-mode" href="javascrip:void(0);"><b style="color:#1b1e21;">切换模式</b></a>
        <span style="flex:1;text-align:right;font-size: 14px;">
            数据中存在一些不规范和非法数据，可能是雪球网升级过程中的历史遗留，因此剔除了该类数据。分析基于五月份平台数据
        </span>
    </div>
    <div class="hr"></div>

    <div id="data-container" style="width: 100%">
        <div class="flex" style="margin-top: 12px;">
            <b style="flex: 1;text-align: center">性别分布</b>
            <b style="flex: 1;margin: 0 1px;text-align: center">活跃度分布</b>
            <b style="flex: 1;text-align: center">粉丝值区间</b>
        </div>

        <div class="flex" style="margin-top: 12px;">
            <div id="gender-table" style="flex: 1;"></div>
            <div id="activation-table" style="flex: 1;margin: 0 1px;"></div>
            <div id="fans-table" style="flex: 1;"></div>
        </div>
        <div class="flex" style="margin-top: 12px;">
            <b style="width: 100%;text-align: center;">用户地域分布</b>
        </div>
        <div id="area-table" style="width: 100%;margin: 12px 0;"></div>
    </div>

    <div id="chart-container" style="width: 100%">
        <div class="flex" style="margin-top: 12px;">
            <div id="gender-chart" style="flex: 1;height:400px;"></div>
            <div id="activation-chart" style="flex: 1;margin: 0 1px;height:400px;"></div>
            <div id="fans-chart" style="flex: 1;height:400px;"></div>
        </div>
        <div id="area-chart" style="width: 100%;margin: 12px 0;height:800px;"></div>
    </div>

    <div id="rank-table-container" style="width: 100%">
        <div class="flex">
            <div class="btn-group">
                <a id="rank-fans" class="dimension btn  active" href="#fakelink">粉丝数</span></a>
                <a id="rank-real-fans" class="dimension btn " href="#fakelink">粉丝数(不含匿名用户)</a>
                <a id="rank-status" class="dimension btn " href="#fakelink">发言数</a>
            </div>
        </div>
        <div id="rank-table" style="width: 100%;"></div>
        <!--<div class="hr"></div>-->
        <div class="flex" style="flex-direction:row-reverse;margin: 12px 0;">
            <div class="footer" id="account-size">共0条数据</div>
            <a id="account-next-page" class="footer" href="javascript:void(0);">下一页</a>
            <div class="footer" id="account-page">1/1</div>
            <a id='account-last-page' class="footer" href="javascript:void(0);">上一页</a>

        </div>
    </div>

    <!--<div style="height:600px;">-->
</div>

<footer class="flex"
        style="background-color:#F8F8F8;width: 100%;height: 72px;padding:0 72px;flex-direction: row-reverse;">
    <a href="javascrip:void(0);" style="width:120px;text-align: right;">意见反馈</a>
    <b style="flex:1;text-align: center">数据来源雪球，仅供参考</b>
    <span style="width:120px;"></span>
</footer>

<script>
    let accountHeadArr = ['性别', '活跃度', '粉丝值'];
    let accountTableIdArr = ['gender-table', 'activation-table', 'fans-table',];
    let accountChartIdArr = ['gender-chart', 'activation-chart', 'fans-chart', 'area-chart'];
    let accountPathArr = ['gender', 'activation', 'fans', 'area'];
    let accountDataArr = [];
    accountPathArr.forEach(function (value, index, array) {
        fetchAccountData(value, index);
    });

    /**
     * 请求接口数据
     * @param type
     * @param level
     */
    function fetchAccountData(type, index) {
        console.log('拉取数据画图表')
        if (accountDataArr[index] != null) {
            console.log('数据不为空')
            if (index < 3) {
                createAccountTable(type, index);
            } else {
                createAreaTable();
            }
            drawChart(type, index);
            return;
        }

        let ajax = new XMLHttpRequest();
        ajax.open('get', 'http://118.25.182.189/moredata/account/' + type);
        ajax.send();
        ajax.onreadystatechange = function () {
            if (ajax.readyState === 4 && ajax.status === 200) {
                let chart = ajax.responseText;
                chart = JSON.parse(chart);
                accountDataArr[index] = chart;
                console.log(chart);
                if (index < 3) {
                    createAccountTable(type, index);
                } else {
                    createAreaTable();
                }
            }
        }
    }

    function createAreaTable() {
        let list = accountDataArr[3].data.list;
        let html = "<table>";
        let htmlArr = ['', '', '', '', '', ''];

        list.forEach(function (item, index, array) {
            let tempIndex = parseInt(index / 12) * 2;
            console.log(tempIndex);
            htmlArr[tempIndex] += '<td style="flex: 1;">' + item['name'] + '</td>';
            htmlArr[tempIndex + 1] += '<td style="flex: 1;">' + item['count'] + '</td>';
        });
        console.log(htmlArr);

        html += '<tr><th>省份</th>' + htmlArr[0] + '</tr>';
        html += '<tr><th>人数</th>' + htmlArr[1] + '</tr>';
        html += '<tr><th>省份</th>' + htmlArr[2] + '</tr>';
        html += '<tr><th>人数</th>' + htmlArr[3] + '</tr>';
        html += '<tr><th>省份</th>' + htmlArr[4] + '</tr>';
        html += '<tr><th>人数</th>' + htmlArr[5] + '</tr>';
        html += "</table>";
        document.getElementById('area-table').innerHTML = html;
    }

    function createAccountTable(type, index) {
        let list = accountDataArr[index].data.list;
        let html = "<table><tr>";
        html += '<th>' + accountHeadArr[index] + '</th>'
        html += '<th style="text-align:right;">人数</th>';
        html += '<th style="text-align:right;">占比/%</th></tr>';

        for (let i = 0, count = 0; count < 7; i++, count++) {
            html += '<tr>';
            let item = list[i];
            if (item == null) {
                html += '<td></td><td style="text-align:right;"></td><td style="text-align:right;"></td></tr>';
                html += '</tr>';
                continue;
            }

            html += '<td>' + item['name'] + '</td>';
            html += '<td style="text-align:right;">' + item['count'] + '</td>';
            html += '<td style="text-align:right;">' + item['percent'].toFixed(4) + '</td></tr>';
        }
        html += "</table>";
        document.getElementById(accountTableIdArr[index]).innerHTML = html;
    }

    function drawChart(type, index) {
        let chart = echarts.init(document.getElementById(accountChartIdArr[index]), 'walden');
        let options = index < 3 ? pieChartOptions(type, index) : areaChartOptions();
        chart.setOption(options);
    }

    let chartTitleArr = ['用户性别分布', '活跃度分布', '粉丝值区间分布', '地域分布'];
    let legendArr = [['男性', '女性', '保密'], ['无发言', '1~10', '11~100', '101~1000', '>1000'],
        ['无人关注', '1~10', '11~100', '101~1000', '1001~10000', '10001~10万', '>10万']];

    function areaChartOptions() {
        let list = accountDataArr[3].data.list;

        let chartData = [];
        list.forEach(function (item) {
            chartData.push({
                name: item['name'],
                value: item['count']
            });
        });
        return {
            title: {
                text: '用户地域分布',
                x: 'center',
                top: 30
            },
            tooltip: {
                trigger: 'item'
            },
            visualMap: {
                min: 100000,
                max: 10000,
                left: 'left',
                top: 'middle',
                text: ['高', '低'],
                // color:['#0052D4','#6FB1FC'],
                calculable: true
            },

            //配置属性
            series: [{
                name: '数据',
                type: 'map',
                mapType: 'china',
                label: {
                    normal: {
                        show: true  //省份名称
                    },
                    emphasis: {
                        show: false
                    }
                },
                data: chartData  //数据
            }]
        };
    }

    function pieChartOptions(type, index) {
        let list = accountDataArr[index].data.list;

        let chartData = [];
        list.forEach(function (item) {
            chartData.push({
                name: item['name'],
                value: item['count']
            });
        });

        let legendX = 'left';
        let legendTop = '30%';
        switch (index) {
            case 1:
                legendX = 'center';
                legendTop = '60px';
                break;
            case 2:
                legendX = 'right';
                legendTop = '30%';
                break;
            case 0:
            default:
                legendX = 'left';
                legendTop = '30%';
                break;

        }

        return {
            title: {
                text: chartTitleArr[index],
                x: 'center',
                top: 20
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b}: {c} ({d}%)"
            },
            legend: {
                top: legendTop,
                orient: index === 1 ? 'horizontal' : 'vertical',
                x: legendX,
                data: legendArr[index]
            },
            series: [
                {
                    name: chartTitleArr[index],
                    type: 'pie',
                    radius: '60%',
                    center: ['50%', '60%'],
                    startAngle: 180,
                    hoverAnimation: false,
                    selectedMode: false,
                    data: chartData
                }
            ]
        };
    }
</script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->

<!-- Bootstrap 4 requires Popper.js -->
<script src="https://unpkg.com/popper.js@1.14.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="scripts/application.js"></script>
<script src="scripts/flat-ui.js"></script>
</body>
</html>